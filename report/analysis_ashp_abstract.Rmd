---
title: Validation of ICD-9-CM/ICD-10-CM Codes for Automated Electronic Scoring of
  APACHE II, APACHE III, and SAPS II
subtitle: Preliminary Analysis for ASHP Abstract Submission
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(tableone)
library(broom)

dirr::get_rds("../data/final")
```

## Patient Selection

* Patients meeting inclusion criteria: `r exclude$screen`
* Reasons for exclusion:
    - Pregnant: `r exclude$pregnant`
    - Prisoner: `r exclude$prisoners`
    - ICU stay < 12 hours: `r exclude$icu_short`
    - Diagnosis coding contained both ICD-9-CM and ICD-10-CM: `r exclude$mult_icd_types`
    - Missing data needed to calculate risk scores: `r exclude$labs_missing`
    - Re-encounters (only included each patient once) : `r exclude$reencounter`
* Total number of eligible patients remaining to sample from: `r flatten_int(exclude)[1] - sum(flatten_int(exclude)[-1])`

## Outcomes

### Primary endpoint

#### APACHE II

##### Comparison of scores

```{r}
scores <- ls(pattern = "score_apache2")

all_scores <- map(scores, ~mutate(get(.x), score = .x)) %>%
    map(~select(.x, pie.id, score, apache2)) %>%
    map_df(~semi_join(.x, manual_patients, by = "pie.id")) 

man <- filter(all_scores, score == "score_apache2_manual")$apache2

t <- all_scores[, -1] %>%
    filter(score != "score_apache2_manual") %>%
    group_by(score) %>%
    do(tidy(t.test(.$apache2, man, paired = TRUE)))

knitr::kable(t)
```

```{r}
kw <- all_scores[, -1] %>%
    filter(score != "score_apache2_manual") %>%
    group_by(score) %>%
    do(tidy(kruskal.test(.$apache2, man, paired = TRUE)))

knitr::kable(kw)
```

##### Difference in score

```{r}
diff <- all_scores %>%
    spread(score, apache2) %>%
    mutate_at(vars(-pie.id, -score_apache2_manual), funs(abs(. - score_apache2_manual))) %>%
    select(-pie.id, -score_apache2_manual)

tbl <- CreateTableOne(vars = names(diff), data = diff)
ptbl <- print(tbl, printToggle = FALSE)
knitr::kable(ptbl, caption = "Mean Difference in APACHE II Scores")
```

```{r}
ptbl <- print(tbl, printToggle = FALSE, nonnormal = names(diff))
knitr::kable(ptbl, caption = "Median Difference in APACHE II Scores")
```

#### APACHE III

##### Comparison of scores

```{r}
scores <- ls(pattern = "score_apache3")

all_scores <- map(scores, ~mutate(get(.x), score = .x)) %>%
    map(~select(.x, pie.id, score, apache3)) %>%
    map_df(~semi_join(.x, manual_patients, by = "pie.id")) 

man <- filter(all_scores, score == "score_apache3_manual")$apache3

t <- all_scores[, -1] %>%
    filter(score != "score_apache3_manual") %>%
    group_by(score) %>%
    do(tidy(t.test(.$apache3, man, paired = TRUE)))

knitr::kable(t)
```

```{r}
kw <- all_scores[, -1] %>%
    filter(score != "score_apache3_manual") %>%
    group_by(score) %>%
    do(tidy(kruskal.test(.$apache3, man, paired = TRUE)))

knitr::kable(kw)
```

##### Difference in score

```{r}
diff <- all_scores %>%
    spread(score, apache3) %>%
    mutate_at(vars(-pie.id, -score_apache3_manual), funs(abs(. - score_apache3_manual))) %>%
    select(-pie.id, -score_apache3_manual)

tbl <- CreateTableOne(vars = names(diff), data = diff)
ptbl <- print(tbl, printToggle = FALSE)
knitr::kable(ptbl, caption = "Mean Difference in APACHE III Scores")
```

```{r}
ptbl <- print(tbl, printToggle = FALSE, nonnormal = names(diff))
knitr::kable(ptbl, caption = "Median Difference in APACHE III Scores")

```

#### SAPS II

##### Comparison of scores

```{r}
scores <- ls(pattern = "score_saps2")

all_scores <- map(scores, ~mutate(get(.x), score = .x)) %>%
    map(~select(.x, pie.id, score, saps2)) %>%
    map_df(~semi_join(.x, manual_patients, by = "pie.id")) 

man <- filter(all_scores, score == "score_saps2_manual")$saps2

t <- all_scores[, -1] %>%
    filter(score != "score_saps2_manual") %>%
    group_by(score) %>%
    do(tidy(t.test(.$saps2, man, paired = TRUE)))

knitr::kable(t)
```

```{r}
kw <- all_scores[, -1] %>%
    filter(score != "score_saps2_manual") %>%
    group_by(score) %>%
    do(tidy(kruskal.test(.$saps2, man, paired = TRUE)))

knitr::kable(kw)
```

##### Difference in score

```{r}
diff <- all_scores %>%
    spread(score, saps2) %>%
    mutate_at(vars(-pie.id, -score_saps2_manual), funs(abs(. - score_saps2_manual))) %>%
    select(-pie.id, -score_saps2_manual)

tbl <- CreateTableOne(vars = names(diff), data = diff)
ptbl <- print(tbl, printToggle = FALSE)
knitr::kable(ptbl, caption = "Mean Difference in SAPS II Scores")
```

```{r}
ptbl <- print(tbl, printToggle = FALSE, nonnormal = names(diff))
knitr::kable(ptbl, caption = "Median Difference in SAPS II Scores")

```

### Secondary endpoints

#### Difference in predicted mortality using SAPS II

```{r}
comorbid <- ls(pattern = "score_saps2_")

all_df <- map(comorbid, ~mutate(get(.x), score = .x)) %>%
    map(~select(.x, pie.id, score, saps2)) %>%
    map_df(~semi_join(.x, manual_patients, by = "pie.id")) %>%
    distinct(pie.id, score, .keep_all = TRUE) %>%
    mutate(logit = -7.763 + 0.0737 * saps2 + 0.9971 * log(saps2 + 1),
           mortality = exp(logit) / (1 + exp(logit))) %>%
    select(pie.id, score, mortality) 

man <- filter(all_df, score == "score_saps2_manual")$mortality

t <- all_df[, -1] %>%
    filter(score != "score_saps2_manual") %>%
    group_by(score) %>%
    do(tidy(t.test(.$mortality, man, paired = TRUE)))

knitr::kable(t[, c(1:4, 6:7)])
```

```{r}
diff <- all_df %>%
    spread(score, mortality) %>%
    mutate_at(vars(-pie.id, -score_saps2_manual), funs(abs(. - score_saps2_manual))) %>%
    select(-pie.id, -score_saps2_manual)

tbl <- CreateTableOne(vars = names(diff), data = diff)
ptbl <- print(tbl, printToggle = FALSE)
knitr::kable(ptbl, caption = "Mean Difference in Predicted Mortality using SAPS II")
```

#### Difference in number of comorbidities identified using APACHE II

```{r}
comorbid <- ls(pattern = "data_apache2_")

all_df <- map(comorbid, ~mutate(get(.x), score = .x)) %>%
    map(~select(.x, pie.id, score, liver:comorbidity)) %>%
    map_df(~semi_join(.x, manual_patients, by = "pie.id")) %>%
    distinct(pie.id, score, .keep_all = TRUE) %>%
    arrange(pie.id, score) %>%
    mutate_if(is.logical, as.numeric) %>%
    by_row(function(x) sum(x[, 3:7], na.rm = TRUE), .collate = "rows", .to = "num_comorbid") %>%
    select(pie.id, score, num_comorbid) 

man <- filter(all_df, score == "data_apache2_manual")$num_comorbid

t <- all_df[, -1] %>%
    filter(score != "data_apache2_manual") %>%
    group_by(score) %>%
    do(tidy(t.test(.$num_comorbid, man, paired = TRUE)))

knitr::kable(t[, c(1:4, 6:7)])
```

```{r}
diff <- all_df %>%
    spread(score, num_comorbid) %>%
    mutate_at(vars(-pie.id, -data_apache2_manual), funs(abs(. - data_apache2_manual))) %>%
    select(-pie.id, -data_apache2_manual)

tbl <- CreateTableOne(vars = names(diff), data = diff)
ptbl <- print(tbl, printToggle = FALSE)
knitr::kable(ptbl, caption = "Mean Difference in Number of APACHE II Comorbidities")
```

```{r}
ptbl <- print(tbl, printToggle = FALSE, nonnormal = names(all_df))
knitr::kable(ptbl, caption = "Median Difference in Number of APACHE II Comorbidities")
```

#### Proportion of patients with a differing primary comorbidity using APACHE III

```{r}
comorbid <- ls(pattern = "data_apache3_")

all_df <- map(comorbid, ~mutate(get(.x), score = .x)) %>%
    map(~select(.x, pie.id, score, comorbidity)) %>%
    map_df(~semi_join(.x, manual_patients, by = "pie.id")) %>%
    distinct(pie.id, score, .keep_all = TRUE) %>%
    spread(score, comorbidity, fill = "") %>%
    mutate_at(vars(-pie.id, -data_apache3_manual), funs(. != data_apache3_manual)) %>%
    mutate_if(is.logical, as.numeric) %>%
    ungroup() %>%
    select(-pie.id, -data_apache3_manual)

tbl <- CreateTableOne(vars = names(all_df), data = all_df)
ptbl <- print(tbl, printToggle = FALSE)
knitr::kable(ptbl, caption = "Proportion of Patients with a Differing Primary Comorbidity using APACHE III")
```

#### Proportion of patients with a differing primary comorbidity using SAPS II

```{r}
comorbid <- ls(pattern = "data_saps2_")

all_df <- map(comorbid, ~mutate(get(.x), score = .x)) %>%
    map(~select(.x, pie.id, score, comorbidity)) %>%
    map_df(~semi_join(.x, manual_patients, by = "pie.id")) %>%
    distinct(pie.id, score, .keep_all = TRUE) %>%
    spread(score, comorbidity, fill = "") %>%
    mutate_at(vars(-pie.id, -data_saps2_manual), funs(. != data_saps2_manual)) %>%
    mutate_if(is.logical, as.numeric) %>%
    ungroup() %>%
    select(-pie.id, -data_saps2_manual)

tbl <- CreateTableOne(vars = names(all_df), data = all_df)
ptbl <- print(tbl, printToggle = FALSE)
knitr::kable(ptbl, caption = "Proportion of Patients with a Differing Primary Comorbidity using SAPS II")
```
