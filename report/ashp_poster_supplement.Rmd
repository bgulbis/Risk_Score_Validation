---
title: "Validation of ICD-9-CM/ICD-10-CM Codes for Automated Electronic Scoring of APACHE II, APACHE III, and SAPS II"
subtitle: "Supplemental Material"
author: "Eric Kao, Brian Gulbis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  tufte::tufte_html: default
bibliography: skeleton.bib
link-citations: yes
---

```{r setup, include=FALSE}
library(tufte)
# invalidate cache when the tufte version changes
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tufte'), echo = FALSE)
options(htmltools.dir.version = FALSE)

library(tidyverse)
library(stringr)
library(forcats)
library(tableone)
library(broom)
library(icd)
library(icuriskr)

dirr::get_rds("../data/final")
```

# Patient Selection

There were `r format(exclude$screen, big.mark = ",")` patient encounters identified which met inclusion criteria. Patients were then excluded for the following reasons:

* Pregnant: `r format(exclude$pregnant, big.mark = ",")`
* Prisoner: `r format(exclude$prisoners, big.mark = ",")`
* Missing data needed to calculate risk scores: `r format(exclude$labs_missing + exclude$mult_icd_types + exclude$icu_short, big.mark = ",")`
* Re-encounters (each patient  once) : `r format(exclude$reencounter, big.mark = ",")`

This left a total of `r format(flatten_int(exclude)[1] - sum(flatten_int(exclude)[-1]), big.mark = ",")` eligible patients remaining. From these, a random sample of 200 patients were selected for inclusion in the study. 

# Comorbidity Definitions

The following tables contain the list of ICD-9-CM and ICD-10-CM codes which were included in the author-defined comorbidity set.^[All child-codes of the codes listed were also included (i.e., 196 includes 196.0, 196.1, etc.)] 


```{r, message=FALSE, warning=FALSE}
icd9 <- comorbidity_map_icd9_ek %>%
    map(sort) %>%
    map(icd_condense, warn = FALSE) %>%
    map(icd_short_to_decimal) %>%
    map(str_c, collapse = ", ") %>%
    simplify() %>%
    as_tibble() %>%
    rownames_to_column("comorbidity")

defs <- read_csv("../data/external/comorbidity_definitions.csv")

df <- defs %>%
    filter(score == "apache2") %>%
    left_join(icd9, by = c("icd" = "comorbidity")) %>%
    select(Group = group, Comorbidity = comorbidity, Criteria = criteria, `ICD-9-CM Code` = value) %>%
    dmap(~ coalesce(.x, ""))

knitr::kable(df, caption = "ICD-9-CM Codes Used in Author-Defined Comorbidity Set for APACHE II")
```

```{r}
icd10 <- comorbidity_map_icd10_ek %>%
    # map(icd_condense, warn = FALSE) %>%
    map(sort) %>%
    map(icd_short_to_decimal) %>%
    map(str_c, collapse = ", ") %>%
    simplify() %>%
    as_tibble() %>%
    rownames_to_column("comorbidity") 

df <- defs %>%
    filter(score == "apache2") %>%
    left_join(icd10, by = c("icd" = "comorbidity")) %>%
    select(Group = group, Comorbidity = comorbidity, Criteria = criteria, `ICD-10-CM Code` = value) %>%
    dmap(~ coalesce(.x, ""))

knitr::kable(df, caption = "ICD-10-CM Codes Used in Author-Defined Comorbidity Set for APACHE II")
```


# Statistical Methods

Data processing, risk score calculations, and statistical analysis were performed using `r R.Version()$version.string` (@R-base). The `icd` package (@R-icd) was used to cross-reference patient diagnosis codes with comorbidity set diagnosis codes.

# Supplemental Results

# References

* R packages
